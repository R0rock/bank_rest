# =========================================================
# /**
#  * @file Dockerfile
#  * @project Bank Cards Application
#  * @description Production Dockerfile для Spring Boot приложения
#  *              с использованием Java 23 и минимального образа OpenJDK.
#  *              Обеспечивает безопасность, лёгкость и готовность к мониторингу.
#  * @author Sergei
#  * @version 1.0
#  * @date 2025-11-12
#  */
# =========================================================

# ---------------------------------------------------------
#  Используем официальный лёгкий образ Java 23
# ---------------------------------------------------------
FROM openjdk:23-jdk-slim

# ---------------------------------------------------------
#  Метаинформация об авторе
# ---------------------------------------------------------
LABEL maintainer="sergei"
LABEL description="Docker image for Bank Cards Spring Boot Application (Java 23)"

# ---------------------------------------------------------
#  Создаём рабочую директорию приложения
# ---------------------------------------------------------
WORKDIR /app

# ---------------------------------------------------------
#  Устанавливаем curl для healthcheck и отладки
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
#  Копируем собранный JAR-файл из целевой директории Maven/Gradle
# ---------------------------------------------------------
COPY target/bank-cards-1.0.0.jar /app/app.jar

# ---------------------------------------------------------
#  Создаём системного пользователя без root-прав
# ---------------------------------------------------------
RUN groupadd -r spring && useradd -r -g spring spring
USER spring

# ---------------------------------------------------------
#  Указываем команду запуска приложения
# ---------------------------------------------------------
ENTRYPOINT ["java", "-jar", "/app/app.jar"]

# ---------------------------------------------------------
#  Определяем healthcheck для Docker
# ---------------------------------------------------------
# Проверяет, отвечает ли приложение на /actuator/health
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# ---------------------------------------------------------
#  Экспортируем порт для доступа к приложению
# ---------------------------------------------------------
EXPOSE 8080

# =========================================================
#  Инструкция по сборке и запуску:
# =========================================================
# 1️ Сборка jar-файла:
#     mvn clean package -DskipTests
#
# 2️ Сборка Docker-образа:
#     docker build -t bank-cards-app .
#
# 3️ Запуск контейнера:
#     docker run -p 8080:8080 bank-cards-app
#
# 4️ Проверка состояния:
#     docker ps
#     docker logs bank-cards-app
# =========================================================